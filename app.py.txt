import streamlit as st

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="èŠ±åˆã‚ã›è¨ˆç®—æ©Ÿ", page_icon="ğŸ´")

st.title("ğŸ´ èŠ±åˆã‚ã›è¨ˆç®—æ©Ÿ")
st.write("èª°ãŒã©ã®æœ­ã‚’æŒã£ã¦ã„ã‚‹ã‹é¸ã‚“ã§ã€æœ€å¾Œã«ã€Œè¨ˆç®—ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚")

# --- 1. ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å®šç¾© (ã‚«ã‚¿ã‚«ãƒŠè¡¨è¨˜) ---
# æœˆ, ç¨®é¡, ç‚¹æ•°, è¡¨ç¤ºå, ID
card_data = [
    # 1æœˆ ãƒãƒ„
    ("1æœˆ", "å…‰", 20, "ãƒãƒ„ã®ãƒ’ã‚«ãƒª(ãƒ„ãƒ«)", "matsu_hikari"),
    ("1æœˆ", "çŸ­å†Š", 5, "ãƒãƒ„ã®ã‚¢ã‚«ã‚¿ãƒ³", "matsu_tan"),
    ("1æœˆ", "ã‚«ã‚¹", 1, "ãƒãƒ„ã®ã‚«ã‚¹(1)", "matsu_kasu_1"),
    ("1æœˆ", "ã‚«ã‚¹", 1, "ãƒãƒ„ã®ã‚«ã‚¹(2)", "matsu_kasu_2"),
    # 2æœˆ ã‚¦ãƒ¡
    ("2æœˆ", "ã‚¿ãƒ", 10, "ã‚¦ãƒ¡ã®ã‚¿ãƒ(ã‚¦ã‚°ã‚¤ã‚¹)", "ume_tane"),
    ("2æœˆ", "çŸ­å†Š", 5, "ã‚¦ãƒ¡ã®ã‚¢ã‚«ã‚¿ãƒ³", "ume_tan"),
    ("2æœˆ", "ã‚«ã‚¹", 1, "ã‚¦ãƒ¡ã®ã‚«ã‚¹(1)", "ume_kasu_1"),
    ("2æœˆ", "ã‚«ã‚¹", 1, "ã‚¦ãƒ¡ã®ã‚«ã‚¹(2)", "ume_kasu_2"),
    # 3æœˆ ã‚µã‚¯ãƒ©
    ("3æœˆ", "å…‰", 20, "ã‚µã‚¯ãƒ©ã®ãƒ’ã‚«ãƒª(ãƒã‚¯)", "sakura_hikari"),
    ("3æœˆ", "çŸ­å†Š", 5, "ã‚µã‚¯ãƒ©ã®ã‚¢ã‚«ã‚¿ãƒ³", "sakura_tan"),
    ("3æœˆ", "ã‚«ã‚¹", 1, "ã‚µã‚¯ãƒ©ã®ã‚«ã‚¹(1)", "sakura_kasu_1"),
    ("3æœˆ", "ã‚«ã‚¹", 1, "ã‚µã‚¯ãƒ©ã®ã‚«ã‚¹(2)", "sakura_kasu_2"),
    # 4æœˆ ãƒ•ã‚¸
    ("4æœˆ", "ã‚¿ãƒ", 10, "ãƒ•ã‚¸ã®ã‚¿ãƒ(ãƒ›ãƒˆãƒˆã‚®ã‚¹)", "fuji_tane"),
    ("4æœˆ", "çŸ­å†Š", 5, "ãƒ•ã‚¸ã®ã‚¿ãƒ³ã‚¶ã‚¯", "fuji_tan"),
    ("4æœˆ", "ã‚«ã‚¹", 1, "ãƒ•ã‚¸ã®ã‚«ã‚¹(1)", "fuji_kasu_1"),
    ("4æœˆ", "ã‚«ã‚¹", 1, "ãƒ•ã‚¸ã®ã‚«ã‚¹(2)", "fuji_kasu_2"),
    # 5æœˆ ã‚¢ãƒ¤ãƒ¡
    ("5æœˆ", "ã‚¿ãƒ", 10, "ã‚¢ãƒ¤ãƒ¡ã®ã‚¿ãƒ(ãƒ¤ãƒ„ãƒã‚·)", "ayame_tane"),
    ("5æœˆ", "çŸ­å†Š", 5, "ã‚¢ãƒ¤ãƒ¡ã®ã‚¢ã‚ªã‚¿ãƒ³", "ayame_tan"),
    ("5æœˆ", "ã‚«ã‚¹", 1, "ã‚¢ãƒ¤ãƒ¡ã®ã‚«ã‚¹(1)", "ayame_kasu_1"),
    ("5æœˆ", "ã‚«ã‚¹", 1, "ã‚¢ãƒ¤ãƒ¡ã®ã‚«ã‚¹(2)", "ayame_kasu_2"),
    # 6æœˆ ãƒœã‚¿ãƒ³
    ("6æœˆ", "ã‚¿ãƒ", 10, "ãƒœã‚¿ãƒ³ã®ã‚¿ãƒ(ãƒãƒ§ã‚¦)", "botan_tane"),
    ("6æœˆ", "çŸ­å†Š", 5, "ãƒœã‚¿ãƒ³ã®ã‚¢ã‚ªã‚¿ãƒ³", "botan_tan"),
    ("6æœˆ", "ã‚«ã‚¹", 1, "ãƒœã‚¿ãƒ³ã®ã‚«ã‚¹(1)", "botan_kasu_1"),
    ("6æœˆ", "ã‚«ã‚¹", 1, "ãƒœã‚¿ãƒ³ã®ã‚«ã‚¹(2)", "botan_kasu_2"),
    # 7æœˆ ãƒã‚®
    ("7æœˆ", "ã‚¿ãƒ", 10, "ãƒã‚®ã®ã‚¿ãƒ(ã‚¤ãƒã‚·ã‚·)", "hagi_tane"),
    ("7æœˆ", "çŸ­å†Š", 5, "ãƒã‚®ã®ã‚¿ãƒ³ã‚¶ã‚¯", "hagi_tan"),
    ("7æœˆ", "ã‚«ã‚¹", 1, "ãƒã‚®ã®ã‚«ã‚¹(1)", "hagi_kasu_1"),
    ("7æœˆ", "ã‚«ã‚¹", 1, "ãƒã‚®ã®ã‚«ã‚¹(2)", "hagi_kasu_2"),
    # 8æœˆ ã‚¹ã‚¹ã‚­
    ("8æœˆ", "å…‰", 20, "ã‚¹ã‚¹ã‚­ã®ãƒ’ã‚«ãƒª(ãƒ„ã‚­)", "susuki_hikari"),
    ("8æœˆ", "ã‚¿ãƒ", 10, "ã‚¹ã‚¹ã‚­ã®ã‚¿ãƒ(ã‚«ãƒª)", "susuki_tane"),
    ("8æœˆ", "ã‚«ã‚¹", 1, "ã‚¹ã‚¹ã‚­ã®ã‚«ã‚¹(1)", "susuki_kasu_1"),
    ("8æœˆ", "ã‚«ã‚¹", 1, "ã‚¹ã‚¹ã‚­ã®ã‚«ã‚¹(2)", "susuki_kasu_2"),
    # 9æœˆ ã‚­ã‚¯
    ("9æœˆ", "ã‚¿ãƒ", 10, "ã‚­ã‚¯ã®ã‚¿ãƒ(ã‚µã‚«ã‚ºã‚­)", "kiku_tane"),
    ("9æœˆ", "çŸ­å†Š", 5, "ã‚­ã‚¯ã®ã‚¢ã‚ªã‚¿ãƒ³", "kiku_tan"),
    ("9æœˆ", "ã‚«ã‚¹", 1, "ã‚­ã‚¯ã®ã‚«ã‚¹(1)", "kiku_kasu_1"),
    ("9æœˆ", "ã‚«ã‚¹", 1, "ã‚­ã‚¯ã®ã‚«ã‚¹(2)", "kiku_kasu_2"),
    # 10æœˆ ãƒ¢ãƒŸã‚¸
    ("10æœˆ", "ã‚¿ãƒ", 10, "ãƒ¢ãƒŸã‚¸ã®ã‚¿ãƒ(ã‚·ã‚«)", "momiji_tane"),
    ("10æœˆ", "çŸ­å†Š", 5, "ãƒ¢ãƒŸã‚¸ã®ã‚¢ã‚ªã‚¿ãƒ³", "momiji_tan"),
    ("10æœˆ", "ã‚«ã‚¹", 1, "ãƒ¢ãƒŸã‚¸ã®ã‚«ã‚¹(1)", "momiji_kasu_1"),
    ("10æœˆ", "ã‚«ã‚¹", 1, "ãƒ¢ãƒŸã‚¸ã®ã‚«ã‚¹(2)", "momiji_kasu_2"),
    # 11æœˆ ãƒ¤ãƒŠã‚®
    ("11æœˆ", "å…‰", 20, "ãƒ¤ãƒŠã‚®ã®ãƒ’ã‚«ãƒª(ã‚ªãƒãƒãƒˆã‚¦ãƒ•ã‚¦)", "yanagi_hikari"),
    ("11æœˆ", "ã‚¿ãƒ", 10, "ãƒ¤ãƒŠã‚®ã®ã‚¿ãƒ(ãƒ„ãƒãƒ¡)", "yanagi_tane"),
    ("11æœˆ", "çŸ­å†Š", 5, "ãƒ¤ãƒŠã‚®ã®ã‚¿ãƒ³ã‚¶ã‚¯", "yanagi_tan"),
    ("11æœˆ", "ã‚«ã‚¹", 1, "ãƒ¤ãƒŠã‚®ã®ã‚«ã‚¹(ã‚«ãƒŸãƒŠãƒª)", "yanagi_kasu"),
    # 12æœˆ ã‚­ãƒª
    ("12æœˆ", "å…‰", 20, "ã‚­ãƒªã®ãƒ’ã‚«ãƒª(ãƒ›ã‚¦ã‚ªã‚¦)", "kiri_hikari"),
    ("12æœˆ", "ã‚«ã‚¹", 1, "ã‚­ãƒªã®ã‚«ã‚¹(1)", "kiri_kasu_1"),
    ("12æœˆ", "ã‚«ã‚¹", 1, "ã‚­ãƒªã®ã‚«ã‚¹(2)", "kiri_kasu_2"),
    ("12æœˆ", "ã‚«ã‚¹", 1, "ã‚­ãƒªã®ã‚«ã‚¹(3)", "kiri_kasu_3"),
]

# --- 2. å½¹åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ä»»å¤©å ‚ èŠ±åˆã‚ã›ãƒ«ãƒ¼ãƒ«) ---
def calculate_score(cards):
    points = sum(c[2] for c in cards)
    card_ids = set(c[4] for c in cards)
    yaku_list = []
    yaku_score = 0
    
    # åˆ¤å®šç”¨ã‚»ãƒƒãƒˆ
    hikari_ids = {c[4] for c in cards if c[1] == "å…‰"}
    tan_ids = {c[4] for c in cards if c[1] == "çŸ­å†Š"}
    
    # --- å½¹åˆ¤å®š ---
    # äº”å…‰ (200ç‚¹)
    if len(hikari_ids) == 5:
        yaku_list.append("ã‚´ã‚³ã‚¦(200)")
        yaku_score += 200
    # å››å…‰ (60ç‚¹)
    elif len(hikari_ids) == 4:
        yaku_list.append("ã‚·ã‚³ã‚¦(60)")
        yaku_score += 60
        
    # ä¸ƒçŸ­ (40ç‚¹)
    if len(tan_ids) >= 7:
        yaku_list.append("ãƒŠãƒŠã‚¿ãƒ³(40)")
        yaku_score += 40
    elif len(tan_ids) == 6:
        yaku_list.append("ãƒ­ã‚¯ã‚¿ãƒ³(30)")
        yaku_score += 30

    # èµ¤çŸ­ (40ç‚¹)
    akatan_set = {"matsu_tan", "ume_tan", "sakura_tan"}
    if akatan_set.issubset(card_ids):
        yaku_list.append("ã‚¢ã‚«ã‚¿ãƒ³(40)")
        yaku_score += 40
        
    # é’çŸ­ (40ç‚¹)
    aotan_set = {"botan_tan", "kiku_tan", "momiji_tan"}
    if aotan_set.issubset(card_ids):
        yaku_list.append("ã‚¢ã‚ªã‚¿ãƒ³(40)")
        yaku_score += 40
        
    # çŒªé¹¿è¶ (20ç‚¹)
    inoshikacho_set = {"hagi_tane", "momiji_tane", "botan_tane"}
    if inoshikacho_set.issubset(card_ids):
        yaku_list.append("ã‚¤ãƒã‚·ã‚«ãƒãƒ§ã‚¦(20)")
        yaku_score += 20
        
    # èŠ±è¦‹ã§ä¸€æ¯ (20ç‚¹)
    hanami_set = {"sakura_hikari", "kiku_tane"}
    if hanami_set.issubset(card_ids):
        yaku_list.append("ãƒãƒŠãƒŸãƒ‡ã‚¤ãƒƒãƒ‘ã‚¤(20)")
        yaku_score += 20
        
    # æœˆè¦‹ã§ä¸€æ¯ (20ç‚¹)
    tsukimi_set = {"susuki_hikari", "kiku_tane"}
    if tsukimi_set.issubset(card_ids):
        yaku_list.append("ãƒ„ã‚­ãƒŸãƒ‡ã‚¤ãƒƒãƒ‘ã‚¤(20)")
        yaku_score += 20

    return points, yaku_score, yaku_list

# --- 3. UIæ§‹ç¯‰ ---
# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒç”¨è¾æ›¸
user_selections = {}

# æœˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã—ã¦è¡¨ç¤º
current_month = ""
for month, type_, point, name, id_ in card_data:
    if month != current_month:
        st.markdown(f"### {month}")
        current_month = month
    
    # é¸æŠãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼ˆæ¨ªä¸¦ã³ï¼‰
    # keyã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
    user_selections[id_] = st.radio(
        label=f"{name}",
        options=["æœª", "A", "B", "C"],
        horizontal=True,
        key=id_
    )
    st.markdown("---") # åŒºåˆ‡ã‚Šç·š

# --- 4. è¨ˆç®—å®Ÿè¡Œ ---
if st.button("è¨ˆç®—ã™ã‚‹", type="primary"):
    # 1. é¸æŠæƒ…å ±ã®åé›†
    p_cards = {'A': [], 'B': [], 'C': []}
    
    # å…¨ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èµ°æŸ»ã—ã¦æŒ¯ã‚Šåˆ†ã‘
    for month, type_, point, name, id_ in card_data:
        owner = user_selections[id_]
        if owner in p_cards:
            p_cards[owner].append((month, type_, point, name, id_))
    
    # 2. è¨ˆç®—
    results = {}
    total_yaku_score = 0
    
    # å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åŸºç¤è¨ˆç®—
    for p_name in ['A', 'B', 'C']:
        cards = p_cards[p_name]
        fuda_ten, yaku_ten, yakus = calculate_score(cards)
        results[p_name] = {
            'fuda': fuda_ten,
            'yaku': yaku_ten,
            'yakus': yakus
        }
        total_yaku_score += yaku_ten
        
    # 3. çµæœè¡¨ç¤º
    st.header("ğŸ´ é›†è¨ˆçµæœ")
    grand_total = 0
    
    cols = st.columns(3) # 3åˆ—ã§è¡¨ç¤º
    
    for i, p_name in enumerate(['A', 'B', 'C']):
        r = results[p_name]
        others_yaku = total_yaku_score - r['yaku']
        final_score = (r['fuda'] - 88) + (r['yaku'] * 2) - others_yaku
        grand_total += final_score
        
        with cols[i]:
            st.subheader(f"ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ {p_name}")
            st.metric(label="æœ€çµ‚å¾—ç‚¹", value=f"{final_score:+}ç‚¹")
            
            st.markdown(f"""
            **è©³ç´°:**
            - ç²å¾—æšæ•°: {len(p_cards[p_name])}æš
            - æœ­ç‚¹: {r['fuda']}ç‚¹
            - å½¹: {', '.join(r['yakus']) if r['yakus'] else 'ãƒŠã‚·'}
            """)

    # æ¤œç®—
    st.markdown("---")
    if grand_total == 0:
        st.success(f"âœ… è¨ˆç®—å®Œäº†ï¼ åˆè¨ˆã¯ãƒ”ãƒƒã‚¿ãƒª 0ç‚¹ ã§ã™ã€‚")
    else:
        st.error(f"âš ï¸ ã‚¨ãƒ©ãƒ¼: åˆè¨ˆãŒ {grand_total}ç‚¹ ã«ãªã£ã¦ã„ã¾ã™ã€‚ã™ã¹ã¦ã®æœ­ã‚’é¸æŠã—ã¾ã—ãŸã‹ï¼Ÿ")